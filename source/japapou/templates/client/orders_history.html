{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/client/cart.css' %}">
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"> -->
{% endblock %}

{% block content %}
<div class="container-carrinho">

    <div class="carrinho-header">
        <h1 class="carrinho-titulo"> <b>Meu Histórico</b> </h1>
        <div class="frete-progress-bar" style="background-color: var(--azul-mais-claro);">
            <div class="progress-fill" style="background-color: var(--laranja-mais-claro); width: 60%;"></div>
        </div>


        <div class="teste">
            <div class="d-flex align-items-center mb-4">
                <select id="order-date-select" class="form-select" onchange="showOrderDetails(this.value)">
                    {% for pedido in pedidos %}
                        {# Valor será 'pedido-ID' para ser usado no JS e ID da div #}
                        <option value="pedido-{{ pedido.id }}" {% if forloop.first %}selected{% endif %}>
                            #{{ pedido.id }} - {{ pedido.created_at|date:"d/m/Y" }}
                        </option>
                    {% empty %}
                        <option value="" disabled selected>Nenhum pedido encontrado</option>
                    {% endfor %}
                </select>
            </div>
            <button class="btn-icone" aria-label="Pesquisar">
                <i class="fas fa-search"></i>
            </button>
        </div>

        <div class="coluna-cabecalho">
            <span class="cab-produto">Produto</span>
            <span class="cab-preco-unitario">Preço Unit.</span>
            <span class="cab-quantidade">Quantidade</span>
            <span class="cab-subtotal"><b>Subtotal</b></span>
        </div>
    </div>
    {# Fim do carrinho-header #}

    {% if not pedidos %}
        <div class="alert alert-info" role="alert">
            Você ainda não finalizou nenhum pedido.
        </div>
        <a href="/" class="btn btn-primary">Começar a comprar</a>
    {% else %}

        {# Itera sobre CADA PEDIDO e cria uma DIV PAI para cada um #}
        {% for pedido in pedidos %}
            {# DIV PAI que será controlada pelo JavaScript. O display: none é substituído pelo JS ao carregar #}
            <div class="order-detail-card" id="pedido-{{ pedido.id }}" style="display: none;">
                
                {# Adicionando uma pequena informação sobre a data/hora do pedido dentro do bloco de detalhes #}
                <p class="text-muted small mt-2">
                    Realizado em: {{ pedido.created_at|date:"d/m/Y \à\s H:i" }}
                </p>

                <div class="lista-itens">
                    {% for item in pedido.itens.all %}
                        <div class="item-carrinho">
                            <div class="item-detalhes">
                                <img
                                    src="{{ item.prato.photo.url }}"
                                    alt="{{ item.prato.name }}"
                                    class="item-imagem"
                                />

                                <div>
                                    <p class="item-nome">{{ item.prato.name }}</p>
                                    <p class="item-especificacoes">Especificações: Sem adição de pimenta.</p>
                                </div>
                            </div>

                            <div class="item-preco-unitario">
                                R$ {{ item.preco_prato|floatformat:2 }}
                            </div>

                            <div class="item-quantidade">
                                {{ item.amount }}x
                            </div>

                            <div class="item-subtotal">
                                R$ {{ item.get_item_total|floatformat:2 }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <hr class="separador">

                <div class="checkout-box">
                    <div class="order-final-container">
                        <div class="total-final-row order">
                            <h3 class="total-titulo order">TOTAL</h3>
                            <div class="total-valor order">
                                {# Mostra o total APENAS do pedido atual #}
                                <b>R$ {{ pedido.total|floatformat:2 }}</b>
                            </div>
                        </div>
                    </div>

                    <div class="checkout-btn-container histórico">
                        <form action="" method="POST">
                            {% csrf_token %}
                            <a href="{% url 'client_receipt' %}">
                                <button type="submit" class="btn-checkout">
                                    Avaliações e Recibo
                                </button>
                            </a>
                        </form>
                        <form action="{% url 'add_to_cart' %}" method="POST">
                            {% csrf_token %}
                            <button type="submit" class="btn-checkout">
                                + Adicionar ao Carrinho
                            </button>
                        </form>
                    </div>
                </div>

            </div>
            {# Fim da DIV PAI do pedido (order-detail-card) #}
        {% endfor %}

    {% endif %}

</div>
<section id="grid-espaco">
    <a href="" class="container-btn-sessao teste2"><p class="btn-sessao teste2">Contate-nos</p></a>
    <div class="grid-container">
        <div class="grid-item area-a">
            <img src="{% static 'imgs/Grid(area-a).png' %}">
            <div class="overlay">Sushi Especial</div>
        </div>

        <div class="grid-item area-b">
            <img src="{% static 'imgs/Grid(area-b).png' %}">
            <div class="overlay">Sashimi Fresco</div>
        </div>

        <div class="grid-item area-c">
            <img src="{% static 'imgs/Grid(area-c).png' %}">
            <div class="overlay">Combinado Premium</div>
        </div>

        <div class="grid-item area-d">
            <img src="{% static 'imgs/Grid(area-d).png' %}">
            <div class="overlay">Onigiri</div>
        </div>

        <div class="grid-item area-e">
            <img src="{% static 'imgs/Grid(area-e).png' %}">
            <div class="overlay">Hot Roll Gourmet</div>
        </div>

    </div>
</section>
    
    <script>
        // Nova função JavaScript para lidar com a seleção no dropdown
        function showOrderDetails(selectedId) {
            // Oculta todos os detalhes dos pedidos
            const allOrders = document.querySelectorAll('.order-detail-card');
            allOrders.forEach(card => {
                card.style.display = 'none';
            });
    
            // Exibe o pedido selecionado
            const selectedOrder = document.getElementById(selectedId);
            if (selectedOrder) {
                selectedOrder.style.display = 'block';
            }
        }
    
        // Chama a função ao carregar a página para exibir o primeiro pedido por padrão
        document.addEventListener('DOMContentLoaded', (event) => {
            const selectElement = document.getElementById('order-date-select');
            if (selectElement && selectElement.options.length > 0) {
                // Certifica-se de que o primeiro item selecionado está visível ao carregar
                showOrderDetails(selectElement.value);
            }
        });
    
        // Funções JavaScript existentes (updateQuantity, etc., permanecem aqui se necessário)
    </script>


{% endblock %}