{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/client/cart.css' %}">
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"> -->

<script>
    // Funções JavaScript para atualizar a quantidade e submeter o formulário
    function updateQuantity(itemId, change) {
        const input = document.getElementById('quantity-' + itemId);
        let current = parseInt(input.value);
        let newValue = current + change;

        if (newValue >= 1) {
            input.value = newValue;
            
            // Submete o formulário quando a quantidade muda
            const form = input.closest('form');
            if (form) {
                form.submit();
            }
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Meu Histórico de Pedidos</h1>

    {% if not pedidos %}
        <div class="alert alert-info" role="alert">
            Você ainda não finalizou nenhum pedido.
        </div>
        <a href="/" class="btn btn-primary">Começar a comprar</a>
    
    {% else %}
        {% for pedido in pedidos %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <strong>Pedido #{{ pedido.id }}</strong>
                </div>
                <div>
                    Realizado em: {{ pedido.created_at|date:"d/m/Y \à\s H:i" }}
                </div>
            </div>
            
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for item in pedido.itens.all %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-secondary rounded-pill me-2">{{ item.amount }}x</span>
                            {{ item.prato.name }}
                        </div>
                        <span>R$ {{ item.prato.price|floatformat:2 }} (unid)</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="card-footer text-end">
                <h5 class="mb-0">Total do Pedido: R$ {{ pedido.total|floatformat:2 }}</h5>
            </div>
        </div>
        {% endfor %}
    {% endif %}

</div>
<div class="container-carrinho">
    
    <div class="carrinho-header">
        <h1 class="carrinho-titulo">Meu Carrinho</h1>

        <p>Compre mais R$ <b class="laranja">[valor]</b> para adquirir frete grátis </p>
        <p>gráfico que a parte concluída é var(--laranja-mais-claro) e o back é var(--azul-mais-claro)</p>
        {# Adicionei um div simples para o gráfico de progresso (a ser estilizado com CSS) #}
        <div class="frete-progress-bar" style="background-color: var(--azul-mais-claro);">
            <div class="progress-fill" style="background-color: var(--laranja-mais-claro); width: 60%;"></div>
        </div>

        <div class="icones-container">
            <button class="btn-icone" aria-label="Pesquisar">
                <i class="fas fa-search"></i>
            </button>
        </div>

        <div class="coluna-cabecalho">
            <span class="cab-produto">Produto</span>
            <span class="cab-preco-unitario">Preço Unit.</span>
            <span class="cab-quantidade">Quantidade</span>
            <span class="cab-subtotal"><b>Subtotal</b></span>
        </div>
    </div>
    {# FECHAMENTO DE DIV MUDOU DE LUGAR PARA COBRIR SOMENTE O HEADER #}

    {% if not pedidos %}
        <div class="carrinho-vazio">
            <p>Seu carrinho está vazio.</p>
            <a href="{% url 'client_menu' %}" class="btn-ver-pratos">Ver pratos</a>
        </div>
    {% else %}
        
        <div class="lista-itens">
            {% for pedido in pedidos %}
                {{ pedido.created_at|date:"d/m/Y \à\s H:i" }}
                {% for item in pedido.itens.all %}
                    <div class="item-carrinho"> 
                        
                        <div class="item-detalhes">
                            <img 
                                src="{{ item.prato.photo.url }}"
                                alt="{{ item.prato.name }}" 
                                class="item-imagem"
                            />
                            <div>
                                <p class="item-nome">{{ item.prato.name }}</p>
                                <p class="item-especificacoes">Especificações: Sem adição de pimenta.</p> 
                                
                                <form action="{% url 'remove_from_cart' %}" method="POST" class="form-remover">
                                    {% csrf_token %}
                                    <input type="hidden" name="item_id" value="{{ item.id }}">
                                    <button type="submit" class="btn-remover">
                                        Remover
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div class="item-preco-unitario">
                            R$ {{ item.prato.price|floatformat:2 }}
                        </div>

                        <div class="item-quantidade">
                            {{ item.amount }}x
                        </div>

                        <div class="item-subtotal">
                            R$ {{ item.get_item_total|floatformat:2 }}
                        </div>
                    </div>
                {% endfor %} 
            {% endfor %}
        <hr class="separador">

        <div class="checkout-box">
            <div class="total-final-container">
                <div class="total-final-row">
                    <h3 class="total-titulo">TOTAL</h3>
                    <div class="total-valor">
                        R$ {{ total|floatformat:2 }}
                    </div>
                </div>
            </div>

            <div class="checkout-btn-container">
                <form action="{% url 'add_to_cart' %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn-checkout">
                       + Adicionar ao Carrinho
                    </button>
                </form>
            </div>
        </div>

    {% endif %}
</div>
</div>

<!-- <section>
    <a href="" class="container-btn-sessao teste2"><p class="btn-sessao teste2">Contate-nos</p></a>
    <div class="grid-container">
        <div class="grid-item area-a">
            <img src="{% static 'imgs/Grid(area-a).png' %}">
            <div class="overlay">Sushi Especial</div>
        </div>

        <div class="grid-item area-b">
            <img src="{% static 'imgs/Grid(area-b).png' %}">
            <div class="overlay">Sashimi Fresco</div>
        </div>

        <div class="grid-item area-c">
            <img src="{% static 'imgs/Grid(area-c).png' %}">
            <div class="overlay">Combinado Premium</div>
        </div>

        <div class="grid-item area-d">
            <img src="{% static 'imgs/Grid(area-d).png' %}">
            <div class="overlay">Onigiri</div>
        </div>

        <div class="grid-item area-e">
            <img src="{% static 'imgs/Grid(area-e).png' %}">
            <div class="overlay">Hot Roll Gourmet</div>
        </div>

    </div>
</section> -->

{% endblock %}