{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/client/cart.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<script>
    // Funções JavaScript para atualizar a quantidade e submeter o formulário
    function updateQuantity(itemId, change) {
        const input = document.getElementById('quantity-' + itemId);
        let current = parseInt(input.value);
        let newValue = current + change;

        if (newValue >= 1) {
            input.value = newValue;
            
            // Submete o formulário quando a quantidade muda
            const form = input.closest('form');
            if (form) {
                form.submit();
            }
        }
    }
    
    // Função para filtrar itens (movida para o escopo global ou para ser chamada diretamente no onkeyup)
    function filterCartItems(searchTerm) {
        const itemsList = document.querySelector('.lista-itens');
        // Adiciona um null check para evitar erro se a lista estiver vazia
        const cartItems = itemsList ? itemsList.querySelectorAll('.item-carrinho') : []; 

        cartItems.forEach(item => {
            const itemNameElement = item.querySelector('.item-nome');
            if (itemNameElement) {
                const itemName = itemNameElement.textContent.toLowerCase();
                
                if (itemName.includes(searchTerm)) {
                    // Garante que o item aparece no layout correto
                    item.style.display = 'flex'; 
                } else {
                    item.style.display = 'none';
                }
            }
        });
    }

    // === NOVO BLOCO: Lógica para mostrar/esconder o campo de busca ===
    document.addEventListener('DOMContentLoaded', () => {
        const toggleBtn = document.getElementById('toggle-search-btn');
        const searchContainer = document.getElementById('search-container');
        const searchInput = document.getElementById('cart-search-input');
    
        if (toggleBtn && searchContainer && searchInput) {
            // Função para mostrar/esconder o campo de busca
            toggleBtn.addEventListener('click', () => {
                // Verifica se o container está visível
                const isVisible = searchContainer.style.display === 'flex' || searchContainer.style.display === '';
                
                // Usa 'flex' para corresponder ao seu layout, garantindo que o Tailwind ou CSS funcione bem
                searchContainer.style.display = isVisible ? 'none' : 'flex';
            
                if (!isVisible) {
                    // Se for visível agora, foca no input
                    searchInput.focus(); 
                } else {
                    // Ao esconder, limpa o campo e restaura a lista
                    searchInput.value = ''; 
                    filterCartItems(''); // Mostra todos os itens novamente
                }
            });
        } else {
            console.error("Erro: Elementos de busca (botão, container ou input) não encontrados.");
        }
    });
    // =================================================================
</script>
{% endblock %}

{% block content %}
<div class="container-carrinho">
    
    <div class="carrinho-header">
        <h1 class="carrinho-titulo">Meu Carrinho</h1>

        <div class="frete-progress-bar" style="background-color: var(--azul-mais-claro);">
            <div class="progress-fill" style="background-color: var(--laranja-mais-claro); width: 60%;"></div>
        </div>

        <div class="icones-container">
            <a href="{% url 'client_menu' %}">
                <button class="btn-icone" aria-label="Adicionar Novo Item">
                    <i class="fas fa-plus-circle"></i>
                </button>
            </a>

            {# ESTE É O BOTÃO DA LUPA. O ID 'toggle-search-btn' É USADO NO JS ABAIXO. #}
            <button id="toggle-search-btn" class="btn-icone" aria-label="Pesquisar">
                <i class="fas fa-search"></i>
            </button>
            <div id="search-container" class="search-container-input" style="display: none;">
                <input 
                    type="text" 
                    id="cart-search-input" 
                    placeholder="Pesquisar prato no carrinho..." 
                    class="form-control"
                    onkeyup="filterCartItems(this.value.toLowerCase())"
                >
            </div>
        </div>
        

        <div class="coluna-cabecalho">
            <span class="cab-produto">Produto</span>
            <span class="cab-preco-unitario">Preço Unit.</span>
            <span class="cab-quantidade">Quantidade</span>
            <span class="cab-subtotal"><b>Subtotal</b></span>
        </div>
    </div>
    {# FECHAMENTO DE DIV MUDOU DE LUGAR PARA COBRIR SOMENTE O HEADER #}

    {% if not items %}
        <div class="carrinho-vazio">
            <p>Seu carrinho está vazio.</p>
            <a href="{% url 'client_menu' %}" class="btn-ver-pratos">Ver pratos</a>
        </div>
    {% else %}
        
        <div class="lista-itens">
            {% for item in items %}
            <div class="item-carrinho"> 
                
                <div class="item-detalhes">
                    <img 
                        src="{{ item.plate.photo.url }}"
                        alt="{{ item.plate.name }}" 
                        class="item-imagem"
                    />
                    <div>
                        <p class="item-nome">{{ item.plate.name }}</p>
                        <p class="item-especificacoes">{{ item.plate.description }}</p> 
                        
                        <form action="{% url 'remove_from_cart' %}" method="POST" class="form-remover">
                            {% csrf_token %}
                            <input type="hidden" name="item_id" value="{{ item.id }}">
                            <button type="submit" class="btn-remover">
                                Remover
                            </button>
                        </form>
                    </div>
                </div>

                <div class="item-preco-unitario">
                    R$ {{ item.plate.price|floatformat:2 }}
                </div>

        
                <div class="item-quantidade">
                    <form action="{% url 'update_cart_item' %}" method="POST" class="quantidade-control">
                        {% csrf_token %}
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        
                        <button type="button" onclick="updateQuantity('{{ item.id }}', -1)" class="btn-quant btn-quant-decremento">
                            –
                        </button>

                        <input 
                            type="number" 
                            name="quantity" 
                            id="quantity-{{ item.id }}" 
                            value="{{ item.quantity }}" 
                            min="1" 
                            max="99" 
                            class="input-quantidade"
                            onchange="this.form.submit()"
                        >

                        <button type="button" onclick="updateQuantity('{{ item.id }}', 1)" class="btn-quant btn-quant-incremento">
                            +
                        </button>
                    </form>
                </div>

                <div class="item-subtotal">
                    R$ {{ item.get_item_total|floatformat:2 }}
                </div>
            </div>
            {% endfor %} {# Fim do loop FOR #}

        <hr class="separador">

        <div class="checkout-box">
            
            <div class="frete-dropdown-container">
                <div class="frete-dropdown-wrapper"> 
                    <select class="frete-dropdown">
                        <option>Estimar Frete</option>
                        <option>Retirada no Local (R$ 0,00)</option>
                        <option>Entrega Padrão (R$ {{ taxa|floatformat:2 }})</option>
                    </select>
                </div>
                {# O SVG de ícone foi removido aqui para corresponder ao seu código mais recente #}
            </div>

            <div class="total-final-container">
                <div class="total-final-row">
                    <h3 class="total-titulo">TOTAL</h3>
                    <div class="total-valor">
                        R$ {{ total }}
                    </div>
                </div>
                <p class="total-descricao">Taxa de frete incluída. Com tudo finalizado, vá ao Check Out</p>
            </div>

            <div class="checkout-btn-container">
                <form action="{% url 'checkout' %}" method="GET">
                    {% csrf_token %}
                    <button type="submit" class="btn-checkout">
                        Check Out
                    </button>
                </form>
            </div>
        </div>

    {% endif %}
</div>
{# Fechamento da div container-carrinho #}
</div> 

<section id="grid-espaco">
    <a href="{% url 'contact' %}" class="container-btn-sessao teste2"><p class="btn-sessao teste2">Contate-nos</p></a>
    <div class="grid-container">
        <div class="grid-item area-a">
            <img src="{% static 'imgs/Grid(area-a).png' %}">
            <div class="overlay">Sushi Especial</div>
        </div>

        <div class="grid-item area-b">
            <img src="{% static 'imgs/Grid(area-b).png' %}">
            <div class="overlay">Sashimi Fresco</div>
        </div>

        <div class="grid-item area-c">
            <img src="{% static 'imgs/Grid(area-c).png' %}">
            <div class="overlay">Combinado Premium</div>
        </div>

        <div class="grid-item area-d">
            <img src="{% static 'imgs/Grid(area-d).png' %}">
            <div class="overlay">Onigiri</div>
        </div>

        <div class="grid-item area-e">
            <img src="{% static 'imgs/Grid(area-e).png' %}">
            <div class="overlay">Hot Roll Gourmet</div>
        </div>

    </div>
</section>

{% block scripts %}

    <script id="dados-do-django" type="application/json">
        {{ dados_js|safe }}
    </script>
    {# O código de busca foi movido para o bloco 'extra_head' para garantir que ele seja executado cedo #}
    {# Removido o script de busca daqui. #}

<script src="{% static 'js/client/cart.js' %}"></script>
{% endblock %}

{% endblock %}