{% extends 'base.html' %}
{% load static %}

{% block title %}
    Pedidos Pendentes 
{% endblock %}
{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/delivery_man/orders.css' %}" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

{% endblock %}

{% block content %}
    <h1>Pedidos Pendente</h1>

    <button id="btn-google-maps" onclick="gerarRotaGoogle()">
         Criar Rota<img src={% static "imgs/google-maps.png" %} width="28"></img>
    </button>

    <div id="container-mapa">
        <div id="mapa-entregas"></div>
    </div>


    {% if pedidos %}
        {% for pedido in pedidos %}
            <div class="pedido-box">
            <div class="pedido-header">Pedido #{{ pedido.id }} - {{ pedido.get_tipo_pedido_display }}</div>
            <div class="pedido-conteudo">
                {% with item_count=pedido.itens.count|default:0 %}
                    {% if item_count >= 4 %}
                            {% with item_count_class='4' %}
                    {% endwith %}
                        {% elif item_count > 0 %}
                    {% with item_count_class=item_count %}
                        {% endwith %}
                    {% else %}
                        {% with item_count_class='1' %}
                        {% endwith %}
                    {% endif %}
                    {% with class_value=item_count_class %}
        
                        <div class="pedido-imagens pedido-imagens--{{ class_value }}">
                            {% for item in pedido.itens.all|slice:":4" %}
                                <img src="{{ item.prato.photo.url }}" alt="{{ item.prato.name }}" />
                            {% endfor %}
                        </div>

                    {% endwith %}

                {% endwith %}

                <div class="pedido-info">
                    <div>
                        <p>
                            <strong>Nome do Cliente:</strong> {{ pedido.usuario.get_full_name|default:pedido.usuario.username }}
                        </p>
                        <br>
                        <p>
                            <strong>Itens:</strong><br />
                            {% for item in pedido.itens.all %}
                                {{ item.amount }}x {{ item.prato.name }} - R$ {{ item.prato.price|floatformat:2 }}<br />
                            {% endfor %}
                            <strong>Total:</strong> R$ {{ pedido.total|floatformat:2 }}
                        </p>
                    </div>

                    {% if pedido.tipo_pedido == 'ENTREGA' %}
                        <div>
                            <p>
                                <strong>Endereço:</strong><br />
                                {{ pedido.endereco_entrega.logradouro }}, {{ pedido.endereco_entrega.numero }}
                                {% if pedido.endereco_entrega.complemento %}
                                    ({{ pedido.endereco_entrega.complemento }})
                                {% endif %}
                                <br />
                                {{ pedido.endereco_entrega.bairro }}, {{ pedido.endereco_entrega.cidade }} - {{ pedido.endereco_entrega.estado }}
                                <br />
                                CEP: {{ pedido.endereco_entrega.cep }}
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
            <br>

            {% if pedido.tipo_pedido == 'ENTREGA' %}
                <a href="{% url 'dm_assign_delivery' order_id=pedido.id %}" class="btn-toggle">
                    Confirmar Entrega
                </a>
            {% endif %}

            <div class="detalhes">
                <p>
                    <strong>Observações:</strong> {{ pedido.notes|default:"Nenhuma observação." }}<br />
                    <strong>Forma de pagamento:</strong> {{ pedido.payment_method }}<br />
                    <strong>Horário do pedido:</strong> {{ pedido.created_at|date:"H:i" }} - {{ pedido.created_at|date:"d/m/Y" }}<br />
                    <strong>Status:</strong> {{ pedido.status }}
                </p>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info" role="alert">
            Nenhum pedido a ser entregue
        </div>
    {% endif %}
    <div class="lightbox-overlay" id="lightbox">
        <img id="lightbox-img" src="" alt="Imagem ampliada" />
    </div>
{% endblock %}

{% block scripts %}

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // O '|safe' é crucial para o Django não estragar as aspas do JSON
        var dadosMapa = JSON.parse('{{ mapa_json|safe }}');
        
    </script>

    

    <script src="{% static 'js/delivery_man/orders.js' %}"></script>
    <script>
        // A função toggleDetalhes não será chamada se o botão for um link <a>.
        // Se você ainda deseja que os detalhes sejam exibidos, será necessário um elemento separado.
        // Caso contrário, esta função pode ser removida se não houver outro elemento chamando-a.
        function toggleDetalhes(button) {
            const detalhesDiv = button.nextElementSibling;
            if (detalhesDiv.style.display === "block") {
                detalhesDiv.style.display = "none";
                button.textContent = "Mais detalhes";
            } else {
                detalhesDiv.style.display = "block";
                button.textContent = "Menos detalhes";
            }
        }
        const TOMTOM_KEY_ = "{{ TOMTOM_KEY }}"; 
    </script>
{% endblock %}